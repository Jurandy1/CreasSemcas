<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Inventário Dinâmico</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <div id="root" class="container mx-auto p-4"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // --- COMPONENTE PRINCIPAL DA APLICAÇÃO ---
    function App() {
      // --- Estados que controlam a aplicação ---
      const [visaoAtiva, setVisaoAtiva] = useState('boasVindas'); // 'boasVindas', 'unidade', 'resumo', 'carregando'
      const [servicoSelecionado, setServicoSelecionado] = useState('');
      const [unidadeSelecionada, setUnidadeSelecionada] = useState('');
      const [dadosExibidos, setDadosExibidos] = useState([]);
      const [tituloDaVisao, setTituloDaVisao] = useState('Bem-vindo!');

      // --- Estruturas de Dados para a Navegação ---
      const unidadesPorServico = {
        creas: [
          { id: 'CREAS Bacanga', nome: 'CREAS Bacanga' },
          { id: 'CREAS Centro', nome: 'CREAS Centro' },
        ],
        cras: [
          { id: 'CRAS João de Deus', nome: 'CRAS João de Deus' },
          { id: 'CRAS Cidade Operária', nome: 'CRAS Cidade Operária' },
        ],
        conselho: [
          { id: 'Conselho Tutelar - Área 1', nome: 'Conselho Tutelar - Área 1' },
          { id: 'Conselho Tutelar - Área 2', nome: 'Conselho Tutelar - Área 2' },
        ]
      };
      
      const arquivosDeDados = {
        creas: './dados/creas_data.js',
        cras: './dados/cras_data.js',
        conselho: './dados/conselho_data.js'
      };

      // --- Funções que lidam com as ações do usuário ---
      const handleServicoChange = (e) => {
        setServicoSelecionado(e.target.value);
        setUnidadeSelecionada('');
        setVisaoAtiva('boasVindas');
        setDadosExibidos([]);
      };

      const handleUnidadeChange = (e) => {
        const novaUnidade = e.target.value;
        setUnidadeSelecionada(novaUnidade);
        if (novaUnidade) {
          carregarDadosDaUnidade(servicoSelecionado, novaUnidade);
        } else {
          setVisaoAtiva('boasVindas');
          setDadosExibidos([]);
        }
      };

      const handleResumoClick = () => {
        setVisaoAtiva('carregando');
        setTituloDaVisao('Carregando Resumo Geral...');
        setServicoSelecionado('');
        setUnidadeSelecionada('');

        Promise.all([
          fetch(arquivosDeDados.creas).then(res => res.json()),
          fetch(arquivosDeDados.cras).then(res => res.json()),
          fetch(arquivosDeDados.conselho).then(res => res.json())
        ])
        .then(dataArrays => {
          const allItems = [].concat(...dataArrays);
          setDadosExibidos(allItems);
          setTituloDaVisao('Resumo Geral de Todas as Unidades');
          setVisaoAtiva('resumo');
        })
        .catch(error => {
          console.error("Erro ao carregar resumo:", error);
          alert("Falha ao carregar o resumo geral.");
          setVisaoAtiva('boasVindas');
        });
      };
      
      const carregarDadosDaUnidade = (servico, unidade) => {
        setVisaoAtiva('carregando');
        setTituloDaVisao(`Carregando dados de ${unidade}...`);
        
        fetch(arquivosDeDados[servico])
          .then(response => response.json())
          .then(todosOsItensDoServico => {
            const itensDaUnidade = todosOsItensDoServico.filter(
              item => item.unit_condition === unidade
            );
            setDadosExibidos(itensDaUnidade);
            setTituloDaVisao(`Inventário de ${unidade}`);
            setVisaoAtiva('unidade');
          })
          .catch(error => {
            console.error("Erro ao carregar dados da unidade:", error);
            alert("Falha ao carregar os dados desta unidade.");
            setVisaoAtiva('boasVindas');
          });
      };
      
      // --- Função que decide qual tela renderizar ---
      const renderizarVisao = () => {
        switch(visaoAtiva) {
          case 'carregando':
            return <div className="text-center p-10"><p className="text-xl font-semibold text-blue-600">Carregando...</p></div>;
          case 'unidade':
          case 'resumo':
            return <TabelaDeItens items={dadosExibidos} />;
          case 'boasVindas':
          default:
            return <div className="text-center p-10"><p className="text-xl text-gray-600">Selecione um serviço e uma unidade para visualizar o inventário.</p></div>;
        }
      }

      return (
        <div className="bg-white rounded-lg shadow-xl p-6 min-h-screen">
          <h1 className="text-3xl font-bold text-gray-800 mb-6">Painel de Inventário</h1>
          
          {/* NAVEGAÇÃO */}
          <div className="p-4 bg-gray-50 rounded-lg border border-gray-200 mb-6 flex flex-col md:flex-row gap-4 items-end">
            <div className="flex-grow w-full md:w-auto">
              <label className="block text-sm font-medium text-gray-700 mb-1">Serviço</label>
              <select onChange={handleServicoChange} value={servicoSelecionado} className="w-full p-3 border border-gray-300 rounded-lg text-base">
                <option value="">Selecione...</option>
                <option value="creas">CREAS</option>
                <option value="cras">CRAS</option>
                <option value="conselho">Conselho Tutelar</option>
              </select>
            </div>
            <div className="flex-grow w-full md:w-auto">
              <label className="block text-sm font-medium text-gray-700 mb-1">Unidade</label>
              <select onChange={handleUnidadeChange} value={unidadeSelecionada} disabled={!servicoSelecionado} className="w-full p-3 border border-gray-300 rounded-lg text-base disabled:bg-gray-200">
                <option value="">Selecione...</option>
                {servicoSelecionado && unidadesPorServico[servicoSelecionado].map((unidade) => (
                  <option key={unidade.id} value={unidade.id}>{unidade.nome}</option>
                ))}
              </select>
            </div>
            <div className="w-full md:w-auto">
              <button onClick={handleResumoClick} className="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg text-base hover:bg-blue-700">
                Ver Resumo Geral
              </button>
            </div>
          </div>

          {/* ÁREA DE CONTEÚDO DINÂMICO */}
          <div className="mt-8">
            <h2 className="text-2xl font-bold text-gray-700 mb-4">{tituloDaVisao}</h2>
            {renderizarVisao()}
          </div>
        </div>
      );
    }
    
    // --- COMPONENTE SIMPLES PARA MOSTRAR A TABELA ---
    function TabelaDeItens({ items }) {
      if (items.length === 0) {
        return <p className="text-gray-500">Nenhum item encontrado para esta seleção.</p>;
      }
      const totalItens = items.reduce((sum, item) => sum + item.quantity, 0);

      return (
        <div>
          <p className="mb-4 text-lg"><strong>Total de Itens na Lista:</strong> {totalItens}</p>
          <div className="overflow-x-auto">
            <table className="min-w-full bg-white border">
              <thead className="bg-gray-200">
                <tr>
                  <th className="py-2 px-4 border">Descrição</th>
                  <th className="py-2 px-4 border">Unidade/Condição</th>
                  <th className="py-2 px-4 border">Quantidade</th>
                  <th className="py-2 px-4 border">Estado</th>
                  <th className="py-2 px-4 border">Doação</th>
                </tr>
              </thead>
              <tbody>
                {items.map(item => (
                  <tr key={item.id} className="border-t">
                    <td className="py-2 px-4 border">{item.description}</td>
                    <td className="py-2 px-4 border">{item.unit_condition}</td>
                    <td className="py-2 px-4 border text-center">{item.quantity}</td>
                    <td className="py-2 px-4 border">{item.state}</td>
                    <td className="py-2 px-4 border">{item.donation}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // Monta a aplicação na div #root
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
