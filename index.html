<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Inventário Unificado</title>
  
  <!-- Dependências via CDN: React, Babel, TailwindCSS e Chart.js -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div id="root" class="container mx-auto p-4"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- COMPONENTES AUXILIARES REUTILIZÁVEIS ---

    function Grafico({ config }) {
      const canvasRef = useRef(null);
      const chartInstanceRef = useRef(null);

      useEffect(() => {
        if (chartInstanceRef.current) {
          chartInstanceRef.current.destroy();
        }
        if (canvasRef.current && config) {
          const ctx = canvasRef.current.getContext('2d');
          chartInstanceRef.current = new Chart(ctx, config);
        }
        return () => {
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
          }
        };
      }, [config]);

      return <div className="bg-white p-4 rounded-lg shadow-md border border-gray-200 h-full"><canvas ref={canvasRef}></canvas></div>;
    }

    function TabelaDeItens({ items }) {
        if (!items || items.length === 0) return <p className="text-gray-500 mt-4 text-center">Nenhum item para exibir.</p>;
        return (
            <div className="overflow-x-auto mt-6 bg-white p-4 rounded-lg shadow-md border border-gray-200">
                <table className="min-w-full">
                    <thead className="bg-gray-800 text-white">
                        <tr>
                            <th className="py-3 px-4 text-left">Descrição</th>
                            <th className="py-3 px-4 text-left">Unidade</th>
                            <th className="py-3 px-4 text-center">Qtd.</th>
                            <th className="py-3 px-4 text-left">Estado</th>
                        </tr>
                    </thead>
                    <tbody className="text-gray-700">
                        {items.map((item, index) => (
                            <tr key={item.id || index} className="border-t hover:bg-gray-50">
                                <td className="py-3 px-4">{item.description}</td>
                                <td className="py-3 px-4">{item.unit_condition}</td>
                                <td className="py-3 px-4 text-center font-bold">{item.quantity}</td>
                                <td className="py-3 px-4"><span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                                    item.state === 'Novo' ? 'bg-green-100 text-green-800' :
                                    item.state === 'Bom' ? 'bg-blue-100 text-blue-800' :
                                    item.state === 'Regular' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-red-100 text-red-800'
                                }`}>{item.state}</span></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        );
    }
    
    // --- COMPONENTE PRINCIPAL DA APLICAÇÃO ---
    function App() {
      const [visaoAtiva, setVisaoAtiva] = useState('boasVindas');
      const [isLoading, setIsLoading] = useState(false);
      const [dadosExibidos, setDadosExibidos] = useState([]);
      const [tituloDaVisao, setTituloDaVisao] = useState('Bem-vindo!');
      const [servicoSelecionado, setServicoSelecionado] = useState('');
      const [unidadeSelecionada, setUnidadeSelecionada] = useState('');
      const [cardData, setCardData] = useState({ totalItems: '...', totalAtencao: '...', totalDoacao: '...' });
      const [chartConfig, setChartConfig] = useState(null);
      const [chartConfigResumo2, setChartConfigResumo2] = useState(null);

      useEffect(() => {
        fetch('./dados/resumo_cards.js')
          .then(res => res.json())
          .then(data => setCardData(data))
          .catch(error => console.error("Erro ao carregar dados dos cards:", error));
      }, []);
      
      useEffect(() => {
        if (!dadosExibidos || dadosExibidos.length === 0) {
          setChartConfig(null);
          setChartConfigResumo2(null);
          return;
        }
        const stateOrder = ['Novo', 'Bom', 'Regular', 'Avariado'];
        const stateColors = ['#16A34A', '#3B82F6', '#FBBF24', '#EF4444'];
        
        const stateCounts = dadosExibidos.reduce((acc, item) => {
            acc[item.state] = (acc[item.state] || 0) + parseInt(item.quantity);
            return acc;
        }, {});
        setChartConfig({
            type: 'bar',
            data: {
                labels: stateOrder,
                datasets: [{ label: 'Quantidade', data: stateOrder.map(state => stateCounts[state] || 0), backgroundColor: stateColors }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Itens por Estado de Conservação', font: { size: 16 } } } }
        });
        
        if (visaoAtiva === 'resumo') {
            const unitCounts = dadosExibidos.reduce((acc, item) => {
                const unitName = item.unit_condition.split(' - ')[0];
                acc[unitName] = (acc[unitName] || 0) + parseInt(item.quantity);
                return acc;
            }, {});
            setChartConfigResumo2({
                type: 'pie',
                data: {
                    labels: Object.keys(unitCounts),
                    datasets: [{ data: Object.values(unitCounts), backgroundColor: ['#34D399', '#3B82F6', '#FBBF24', '#EF4444', '#A855F7', '#F97316', '#14B8A6', '#6366F1', '#F59E0B', '#D946EF'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Distribuição de Itens por Unidade', font: { size: 16 } } } }
            });
        }
      }, [dadosExibidos, visaoAtiva]);

      // ==================================================================
      // LISTA DE UNIDADES ATUALIZADA
      // ==================================================================
      const unidadesPorServico = {
        creas: [ 
            { id: 'Bacanga', nome: 'CREAS Bacanga' }, 
            { id: 'Centro', nome: 'CREAS Centro' },
            { id: 'Cidade Operária', nome: 'CREAS Cidade Operária' },
            { id: 'Sol e Mar', nome: 'CREAS Sol e Mar' }
        ],
        conselho: [ 
            { id: 'ANIL', nome: 'CT ANIL' }, 
            { id: 'BACANGA', nome: 'CT BACANGA' }, 
            { id: 'CENTRO/ALEAMANHA', nome: 'CT CENTRO/ALEAMANHA' },
            { id: 'CIDADE OPERARIA', nome: 'CT CIDADE OPERARIA' },
            { id: 'COHAB', nome: 'CT COHAB' },
            { id: 'COROADINHO', nome: 'CT COROADINHO' },
            { id: 'CT ZONA RURAL', nome: 'CT ZONA RURAL' },
            { id: 'SÃO CRISTOVAO', nome: 'CT SÃO CRISTOVAO' },
            { id: 'SÃO FRANCISCO', nome: 'CT SÃO FRANCISCO' },
            { id: 'VILA LUIZAO', nome: 'CT VILA LUIZAO' },
        ]
      };
      
      const arquivosDeDados = {
        creas: './dados/creas_data.js',
        conselho: './dados/conselho_data.js'
      };

      const fetchData = (url, processData) => {
        setIsLoading(true);
        setVisaoAtiva('carregando');
        fetch(url)
          .then(res => res.ok ? res.json() : Promise.reject(`Erro: ${res.statusText}`))
          .then(data => {
            processData(data);
          })
          .catch(error => {
            console.error("Falha ao buscar dados:", error);
            alert("Não foi possível carregar os dados. Verifique se o arquivo existe e o caminho está correto.");
            setVisaoAtiva('boasVindas');
          })
          .finally(() => setIsLoading(false));
      };

      const handleUnidadeChange = (e) => {
        const novaUnidade = e.target.value;
        setUnidadeSelecionada(novaUnidade);
        if (novaUnidade) {
            setTituloDaVisao(`Carregando: ${novaUnidade}...`);
            fetchData(arquivosDeDados[servicoSelecionado], allData => {
                const itensDaUnidade = allData.filter(item => item.unit_condition.startsWith(novaUnidade));
                setDadosExibidos(itensDaUnidade);
                setVisaoAtiva('unidade');
                const unidadeInfo = unidadesPorServico[servicoSelecionado].find(u => u.id === novaUnidade);
                setTituloDaVisao(`Inventário de ${unidadeInfo.nome}`);
            });
        } else {
            setVisaoAtiva('boasVindas');
            setTituloDaVisao('Bem-vindo!');
            setDadosExibidos([]);
        }
      };
      
      const handleResumoClick = () => {
        setTituloDaVisao('Carregando Resumo Geral...');
        setIsLoading(true);
        setVisaoAtiva('carregando');
        Promise.all([
          fetch(arquivosDeDados.creas).then(res => res.json()),
          fetch(arquivosDeDados.conselho).then(res => res.json())
        ])
          .then(dataArrays => {
            const allItems = [].concat(...dataArrays);
            setDadosExibidos(allItems);
            setTituloDaVisao('Resumo Geral do Inventário');
            setVisaoAtiva('resumo');
          })
          .catch(error => {
            console.error("Erro ao carregar resumo:", error);
            setVisaoAtiva('boasVindas');
          })
          .finally(() => setIsLoading(false));
      };

      return (
        <div>
          {/* ================================================================== */}
          {/* BANNER CORRIGIDO - Colocado aqui no topo para garantir a visibilidade */}
          {/* ================================================================== */}
          <img 
            src="https://i.ibb.co/VWNnCH2w/99f63c64-a035-47c8-a8a5-bce7abbe205e.png" 
            alt="Banner do Painel de Inventário" 
            className="w-full max-w-2xl mx-auto h-auto object-contain rounded-lg mb-6"
          />
          
          <div className="bg-white rounded-lg shadow-xl p-4 md:p-6 lg:p-8">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
              <div className="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500"><h3 className="text-xl font-semibold text-blue-800 mb-2">Total de Itens</h3><p className="text-4xl font-bold text-blue-700">{cardData.totalItems}</p></div>
              <div className="bg-orange-50 p-6 rounded-lg border-l-4 border-orange-500"><h3 className="text-xl font-semibold text-orange-800 mb-2">Itens c/ Atenção</h3><p className="text-4xl font-bold text-orange-700">{cardData.totalAtencao}</p></div>
              <div className="bg-purple-50 p-6 rounded-lg border-l-4 border-purple-500"><h3 className="text-xl font-semibold text-purple-800 mb-2">Itens de Doação</h3><p className="text-4xl font-bold text-purple-700">{cardData.totalDoacao}</p></div>
            </div>

            <div className="p-4 bg-gray-50 rounded-lg border mb-8 flex flex-col md:flex-row gap-4 items-end">
                <div className="flex-grow w-full md:w-auto">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Serviço</label>
                    <select onChange={e => {setServicoSelecionado(e.target.value); setUnidadeSelecionada(''); setVisaoAtiva('boasVindas');}} value={servicoSelecionado} className="w-full p-3 border border-gray-300 rounded-lg text-base">
                        <option value="">Selecione...</option>
                        <option value="creas">CREAS</option>
                        <option value="conselho">Conselho Tutelar</option>
                    </select>
                </div>
                <div className="flex-grow w-full md:w-auto">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Unidade</label>
                    <select onChange={handleUnidadeChange} value={unidadeSelecionada} disabled={!servicoSelecionado} className="w-full p-3 border border-gray-300 rounded-lg text-base disabled:bg-gray-200">
                        <option value="">Selecione...</option>
                        {servicoSelecionado && unidadesPorServico[servicoSelecionado]?.map(unidade => (
                            <option key={unidade.id} value={unidade.id}>{unidade.nome}</option>
                        ))}
                    </select>
                </div>
                <div className="w-full md:w-auto">
                    <button onClick={handleResumoClick} className="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg text-base hover:bg-blue-700">Ver Resumo Geral</button>
                </div>
            </div>

            <main className="mt-8">
              <h2 className="text-3xl font-bold text-gray-800 mb-6">{tituloDaVisao}</h2>
              {isLoading && <div className="text-center p-20"><p className="text-2xl font-semibold text-blue-600 animate-pulse">A carregar...</p></div>}
              {!isLoading && visaoAtiva === 'boasVindas' && <div className="text-center p-20 bg-gray-50 rounded-lg shadow-inner"><p className="text-2xl text-gray-600">Selecione um serviço e uma unidade para começar.</p></div>}
              {!isLoading && (visaoAtiva === 'unidade' || visaoAtiva === 'resumo') && (
                <div>
                  <div className={`grid grid-cols-1 ${visaoAtiva === 'resumo' ? 'lg:grid-cols-2' : ''} gap-6`}>
                    <Grafico config={chartConfig} />
                    {visaoAtiva === 'resumo' && <Grafico config={chartConfigResumo2} />}
                  </div>
                  <TabelaDeItens items={dadosExibidos} />
                </div>
              )}
            </main>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
